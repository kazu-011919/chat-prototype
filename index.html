<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è£½é€ 2èª²ãƒãƒ£ãƒƒãƒˆï¼ˆè©¦ä½œ å®Œå…¨ç‰ˆï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:#f4f6f8;color:#222}
  header{background:#0b63c5;color:#fff;padding:12px 16px}
  main{padding:12px;display:flex;gap:12px;flex-wrap:wrap}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
  #left{width:320px;min-width:260px}
  #center{flex:1;min-width:260px}
  #right{width:260px;min-width:200px}
  select,input,textarea,button{width:100%;box-sizing:border-box;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
  button{background:#0b63c5;color:#fff;border:none}
  .muted{color:#666;font-size:13px}
  .messages{height:420px;overflow:auto;padding:8px;border-radius:6px;border:1px solid #eee;background:#fafafa}
  .msg{padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #eee;background:#fff}
  .meta{font-size:12px;color:#666;margin-bottom:6px}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;color:#fff;font-size:12px}
  .badge.admin{background:#6f42c1}
  .badge.kacho{background:#28a745}
  .badge.kicho{background:#dc3545}
  .badge.general{background:#007bff}
  .small{font-size:12px;color:#555}
  .admin-row{display:flex;gap:8px;align-items:center}
  .file-link{display:block;margin-top:6px;color:#0b63c5;text-decoration:none}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #eee;padding:6px;text-align:left;font-size:13px}
  .right-actions{display:flex;gap:6px}
  .link-btn{background:#fff;color:#0b63c5;border:1px solid #0b63c5;padding:6px;border-radius:6px}
</style>
</head>
<body>
<header>
  <h1>è£½é€ 2èª²ãƒãƒ£ãƒƒãƒˆï¼ˆè©¦ä½œ å®Œå…¨ç‰ˆï¼‰</h1>
</header>

<main>
  <!-- å·¦ï¼šãƒ­ã‚°ã‚¤ãƒ³ï¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <section id="left" class="card">
    <h3>ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <label>åå‰ï¼ˆé¸æŠï¼‰</label>
    <select id="login-select"></select>
    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
    <input id="login-pass" type="password" placeholder="åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ•°å­—ã®ã¿å¯ï¼‰" />
    <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <p class="muted">åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šç®¡ç†è€…ãƒ»ä¿‚é•·ãƒ»æ©Ÿé•·ç­é•·ãƒ»ä¸€èˆ¬ãŒç™»éŒ²æ¸ˆã¿</p>
    <hr />
    <h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
    <ul id="calendar-list" class="muted"></ul>
    <div id="calendar-admin" style="display:none">
      <hr />
      <h4>äºˆå®šè¿½åŠ ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</h4>
      <input id="cal-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«(ä¾‹: å¯¾ç­–æ›¸ä½œæˆ)" />
      <input id="cal-until" placeholder="æœŸé™ (YYYY-MM-DD) ä¾‹: 2025-08-30" />
      <button id="cal-add">è¿½åŠ </button>
    </div>
  </section>

  <!-- ä¸­å¤®ï¼šãƒãƒ£ãƒƒãƒˆ -->
  <section id="center" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="logged-info" class="small">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
      </div>
      <div id="logout-area" style="display:none">
        <button id="logout-btn" class="link-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <hr />
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label style="width:40%">é…ä¿¡å…ˆ</label>
      <select id="target-select" style="width:60%">
        <option value="general">ä¸€èˆ¬ï¼ˆå…¨å“¡ï¼‰</option>
        <option value="kacho">ä¿‚é•·</option>
        <option value="kicho">æ©Ÿé•·ãƒ»ç­é•·</option>
      </select>
    </div>

    <div id="messages" class="messages"></div>

    <div style="margin-top:8px">
      <textarea id="msg-text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" rows="3"></textarea>
      <input id="file-input" type="file" accept=".pdf,image/*" />
      <div style="display:flex;gap:8px">
        <button id="send-btn">é€ä¿¡</button>
        <button id="clear-btn" class="link-btn">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
  </section>

  <!-- å³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ / ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <aside id="right" class="card">
    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
    <div id="user-list" class="muted"></div>
    <hr />
    <div id="admin-panel" style="display:none">
      <h3>ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div style="margin-bottom:8px">
        <input id="new-name" placeholder="æ°å" />
        <select id="new-role">
          <option value="general">ä¸€èˆ¬</option>
          <option value="kicho">æ©Ÿé•·ç­é•·</option>
          <option value="kacho">ä¿‚é•·</option>
          <option value="admin">ç®¡ç†è€…</option>
        </select>
        <input id="new-pass" placeholder="åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(4-12)" />
        <button id="add-user-btn">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
      </div>
      <div>
        <table>
          <thead><tr><th>åå‰</th><th>è·åˆ¶</th><th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="admin-user-table"></tbody>
        </table>
      </div>
    </div>
  </aside>
</main>

<script>
/*
  å®Œå…¨éƒ¨ç½²ãƒãƒ£ãƒƒãƒˆï¼ˆPWAè©¦ä½œç‰ˆï¼‰ - å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«
  æ©Ÿèƒ½:
  - è·åˆ¶é †: ç®¡ç†è€… > ä¿‚é•· > æ©Ÿé•·ç­é•· > ä¸€èˆ¬
  - è‡ªåˆ†ã®è·åˆ¶ã¨ä¸‹ä½ã®æŠ•ç¨¿ã‚’é–²è¦§å¯èƒ½ï¼ˆuserRank >= targetRankï¼‰
  - ç®¡ç†è€…ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤ºãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤ºç·¨é›†ãƒ»è¿½åŠ ãƒ»å‰Šé™¤
  - PDF / ç”»åƒæ·»ä»˜ï¼ˆData URLã§localStorageä¿å­˜ï¼‰â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
  - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç®¡ç†è€…ã¯è¿½åŠ å¯ï¼‰ã€åˆæœŸã‚¤ãƒ™ãƒ³ãƒˆã€Œå¯¾ç­–æ›¸ä½œæˆ 2025-08-30ã€
  - æ—¢èª­ç®¡ç†ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¯ã«æ—¢èª­é…åˆ—ã‚’ä¿æŒï¼‰, ç®¡ç†è€…ã¯æ—¢èª­è€…ä¸€è¦§ã‚’ç¢ºèªå¯
  - æ°¸ç¶šåŒ–ï¼šlocalStorage ä½¿ç”¨ï¼ˆç«¯æœ«å˜ä½ï¼‰
*/

const LS_USERS = 'chatv2_users';
const LS_MSGS = 'chatv2_msgs';
const LS_CAL = 'chatv2_cal';

// åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ãªã‘ã‚Œã°æŠ•å…¥ï¼‰
const defaultUsers = [
  {id:'u_admin', name:'å±±ç”°åˆ©è‡³', role:'admin', password:'admin123'},
  {id:'u_kicho', name:'å€‰ç”°å¥å¤ª', role:'kicho', password:'kenta2025'},
  {id:'u_kacho', name:'å®‰è—¤æ­£æ¨¹', role:'kacho', password:'ando1234'},
  {id:'u_bancho', name:'å°æ—èŒ‚å…‰', role:'kicho', password:'kobayashi1'},
  {id:'u_general', name:'å±±ç”°å¤ªéƒ', role:'general', password:'user1234'}
];

const defaultCal = [
  {id:'ev1', title:'å¯¾ç­–æ›¸ä½œæˆ', until:'2025-08-30'}
];

// role rank: higher number = more authority
const roleRank = { admin:4, kacho:3, kicho:2, bancho:2, general:1 };

// restore or init
function initStorage(){
  if(!localStorage.getItem(LS_USERS)) localStorage.setItem(LS_USERS, JSON.stringify(defaultUsers));
  if(!localStorage.getItem(LS_MSGS)) localStorage.setItem(LS_MSGS, JSON.stringify([]));
  if(!localStorage.getItem(LS_CAL)) localStorage.setItem(LS_CAL, JSON.stringify(defaultCal));
}
initStorage();

let users = JSON.parse(localStorage.getItem(LS_USERS));
let messages = JSON.parse(localStorage.getItem(LS_MSGS));
let calendar = JSON.parse(localStorage.getItem(LS_CAL));
let currentUser = null;

// DOM refs
const loginSelect = document.getElementById('login-select');
const loginPass = document.getElementById('login-pass');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loggedInfo = document.getElementById('logged-info');
const messagesDiv = document.getElementById('messages');
const targetSelect = document.getElementById('target-select');
const msgText = document.getElementById('msg-text');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const userListDiv = document.getElementById('user-list');
const adminPanel = document.getElementById('admin-panel');
const adminUserTable = document.getElementById('admin-user-table');
const addUserBtn = document.getElementById('add-user-btn');
const newName = document.getElementById('new-name');
const newRole = document.getElementById('new-role');
const newPass = document.getElementById('new-pass');
const calendarList = document.getElementById('calendar-list');
const calAdmin = document.getElementById('calendar-admin');
const calAdd = document.getElementById('cal-add');
const calTitle = document.getElementById('cal-title');
const calUntil = document.getElementById('cal-until');
const adminMenuWrap = document.getElementById('admin-panel');

// populate login select & user list
function refreshUsers(){
  users = JSON.parse(localStorage.getItem(LS_USERS) || '[]');
  loginSelect.innerHTML = '<option value="">-- é¸æŠ --</option>';
  userListDiv.innerHTML = '';
  users.forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.id;
    opt.textContent = u.name + 'ï¼ˆ' + roleLabel(u.role) + 'ï¼‰';
    loginSelect.appendChild(opt);

    const p = document.createElement('p');
    p.textContent = u.name + 'ï¼ˆ' + roleLabel(u.role) + 'ï¼‰';
    userListDiv.appendChild(p);
  });
  // admin table
  renderAdminTable();
}
function roleLabel(r){
  if(r==='admin') return 'ç®¡ç†è€…';
  if(r==='kacho') return 'ä¿‚é•·';
  if(r==='kicho' || r==='bancho') return 'æ©Ÿé•·ç­é•·';
  return 'ä¸€èˆ¬';
}
refreshUsers();
renderCalendar();

// login
loginBtn.addEventListener('click', ()=>{
  const uid = loginSelect.value;
  const pass = loginPass.value;
  if(!uid){ alert('åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const u = users.find(x=>x.id===uid);
  if(!u){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  if(u.password !== pass){ alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
  currentUser = u;
  onLogin();
});

// logout
logoutBtn.addEventListener('click', ()=>{
  location.reload();
});

function onLogin(){
  document.getElementById('logged-info').textContent = currentUser.name + 'ï¼ˆ' + roleLabel(currentUser.role) + 'ï¼‰';
  document.getElementById('logout-area').style.display = 'block';
  document.getElementById('login-select').disabled = true;
  document.getElementById('login-pass').disabled = true;
  loginBtn.disabled = true;
  // admin panel visibility
  if(currentUser.role === 'admin'){
    adminPanel.style.display = 'block';
    calAdmin.style.display = 'block';
  } else {
    adminPanel.style.display = 'none';
    calAdmin.style.display = 'none';
  }
  renderMessages();
}

// permission logic: userRank >= targetRank allows view/send
function targetRankFromValue(val){
  if(val === 'general') return 1;
  if(val === 'kicho') return 2;
  if(val === 'kacho') return 3;
  return 1;
}
function canUserViewMsg(msg){
  if(!currentUser) return false;
  const userRank = roleRank[currentUser.role] || roleRank['general'];
  const trgRank = targetRankFromValue(msg.target);
  return userRank >= trgRank;
}
function canUserSendTo(targetVal){
  if(!currentUser) return false;
  const userRank = roleRank[currentUser.role] || roleRank['general'];
  const trgRank = targetRankFromValue(targetVal);
  return userRank >= trgRank;
}

// send message
sendBtn.addEventListener('click', async ()=>{
  if(!currentUser){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  const text = msgText.value.trim();
  const targetVal = targetSelect.value;
  if(!canUserSendTo(targetVal)){ alert('ã“ã®é…ä¿¡å…ˆã«ã¯é€ä¿¡ã§ãã¾ã›ã‚“'); return; }
  let fileObj = null;
  if(fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    // limit size simple check (10MB)
    if(f.size > 10*1024*1024){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„'); return; }
    fileObj = await fileToDataURL(f);
  }
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const id = 'm' + Date.now();
  const m = { id, senderId: currentUser.id, senderName: currentUser.name, senderRole: currentUser.role, target: targetVal, text, time: new Date().toISOString(), file: fileObj, readBy: [] };
  msgs.push(m);
  localStorage.setItem(LS_MSGS, JSON.stringify(msgs));
  msgText.value=''; fileInput.value='';
  messages = msgs;
  renderMessages();
});

// file to dataURL
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res({name:file.name,data:fr.result,type:file.type});
    fr.onerror = ()=> rej();
    fr.readAsDataURL(file);
  });
}

// render messages
function renderMessages(){
  messages = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  messagesDiv.innerHTML = '';
  messages.forEach(m=>{
    if(!canUserViewMsg(m)) return;
    const div = document.createElement('div'); div.className='msg';
    const meta = document.createElement('div'); meta.className='meta';
    const badge = document.createElement('span'); badge.className='badge ' + (m.senderRole==='admin'?'admin':(m.target==='kacho'?'kacho':(m.target==='kicho'?'kicho':'general')));
    badge.textContent = roleLabel(m.senderRole);
    meta.innerHTML = `<strong>${m.senderName}</strong> `;
    meta.prepend(badge);
    meta.innerHTML += 'ã€€' + new Date(m.time).toLocaleString();
    div.appendChild(meta);
    const txt = document.createElement('div'); txt.textContent = m.text; div.appendChild(txt);
    if(m.file){
      const a = document.createElement('a');
      a.href = m.file.data;
      a.download = m.file.name;
      a.className = 'file-link';
      a.textContent = 'ğŸ“ ' + m.file.name + ' ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰';
      div.appendChild(a);
    }
    const readInfo = document.createElement('div'); readInfo.className='small';
    readInfo.textContent = 'æ—¢èª­ï¼š' + (m.readBy?m.readBy.length:0) + ' äºº';
    // admin: è©³ç´°è¦‹ã‚‹ãƒœã‚¿ãƒ³
    if(currentUser && currentUser.role === 'admin'){
      const btn = document.createElement('button');
      btn.textContent = 'æ—¢èª­è€…ã‚’è¡¨ç¤º';
      btn.style.marginLeft='8px';
      btn.className='link-btn';
      btn.onclick = ()=> { showReadDetail(m.id); };
      readInfo.appendChild(btn);
    }
    div.appendChild(readInfo);
    messagesDiv.appendChild(div);
    // mark read for this user
    markRead(m.id);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// mark read: add currentUser.id to message.readBy
function markRead(msgId){
  if(!currentUser) return;
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const m = msgs.find(x=>x.id === msgId);
  if(!m) return;
  if(!m.readBy) m.readBy = [];
  if(!m.readBy.includes(currentUser.id)){
    m.readBy.push(currentUser.id);
    localStorage.setItem(LS_MSGS, JSON.stringify(msgs));
  }
  // update visual count if needed
  // (re-rendering will show updated counts)
}

// admin: show read detail
function showReadDetail(msgId){
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const m = msgs.find(x=>x.id===msgId);
  if(!m) return alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  const names = (m.readBy||[]).map(id=>{ const u=users.find(x=>x.id===id); return u?u.name:id; });
  alert('æ—¢èª­è€…:\n' + (names.length? names.join('\n') : 'ãªã—'));
}

// admin user table render (show password editable)
function renderAdminTable(){
  adminUserTable.innerHTML = '';
  users.forEach((u, idx)=>{
    const tr = document.createElement('tr');
    const nameTd = document.createElement('td'); nameTd.textContent = u.name;
    const roleTd = document.createElement('td'); roleTd.textContent = roleLabel(u.role);
    const passTd = document.createElement('td');
    const passInput = document.createElement('input');
    passInput.type='text'; passInput.value = u.password; passInput.style.width='100%';
    passInput.onchange = ()=> { users[idx].password = passInput.value; localStorage.setItem(LS_USERS, JSON.stringify(users)); refreshUsers(); };
    passTd.appendChild(passInput);
    const opTd = document.createElement('td');
    const delBtn = document.createElement('button'); delBtn.textContent='å‰Šé™¤'; delBtn.className='link-btn';
    delBtn.onclick = ()=> { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ users.splice(idx,1); localStorage.setItem(LS_USERS, JSON.stringify(users)); refreshUsers(); } };
    opTd.appendChild(delBtn);
    tr.appendChild(nameTd); tr.appendChild(roleTd); tr.appendChild(passTd); tr.appendChild(opTd);
    adminUserTable.appendChild(tr);
  });
}

// add user
addUserBtn.addEventListener('click', ()=>{
  const name = newName.value.trim(); const role = newRole.value; const pass = newPass.value.trim();
  if(!name || !pass){ alert('æ°åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const id = 'u' + Date.now();
  users.push({id, name, role, password: pass});
  localStorage.setItem(LS_USERS, JSON.stringify(users));
  newName.value=''; newPass.value='';
  refreshUsers();
});

// calendar render
function renderCalendar(){
  calendar = JSON.parse(localStorage.getItem(LS_CAL) || '[]');
  calendarList.innerHTML = '';
  calendar.forEach(ev=>{
    const li = document.createElement('li');
    li.textContent = ev.title + ' ã€œ ' + ev.until;
    calendarList.appendChild(li);
  });
}
renderCalendar();

// calendar add (admin)
calAdd.addEventListener('click', ()=>{
  const t = calTitle.value.trim(); const u = calUntil.value.trim();
  if(!t || !u) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const id = 'ev' + Date.now();
  calendar.push({id, title: t, until: u});
  localStorage.setItem(LS_CAL, JSON.stringify(calendar));
  calTitle.value=''; calUntil.value='';
  renderCalendar();
});

// helper: role label string to internal key mapping for select if necessary
// (we use 'general','kicho','kacho' values for target selection)
// initial refresh
refreshUsers();
renderMessages();

// clear messages (dev)
document.getElementById('clear-btn').addEventListener('click', ()=>{
  if(confirm('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ä¿å­˜ã‚‚æ¶ˆãˆã¾ã™ï¼‰')){
    localStorage.setItem(LS_MSGS, JSON.stringify([]));
    messages = [];
    renderMessages();
  }
});

// convenience: allow Enter to send in textarea (Ctrl+Enter on desktop)
msgText.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});
</script>
</body>
</html>