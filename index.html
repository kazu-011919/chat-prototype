<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>職制別チャット</title>
<style>
body { font-family: sans-serif; }
#chatScreen, #adminMenu { display:none; }
#messages { border:1px solid #ccc; height:200px; overflow-y:auto; padding:5px; margin-bottom:10px;}
.msg { border-bottom:1px solid #eee; padding:3px; }
.role { font-size:0.8em; color:#666; }
</style>
</head>
<body>

<!-- ログイン画面 -->
<div id="loginScreen">
<h3>ログイン</h3>
名前: <input id="loginName"><br>
パスワード: <input type="password" id="loginPass"><br>
<button onclick="login()">ログイン</button>
</div>

<!-- チャット画面 -->
<div id="chatScreen">
<h3>ようこそ <span id="currentUser"></span> さん</h3>
<div id="messages"></div>
<input id="msgInput" placeholder="メッセージ">
<button onclick="sendMessage()">送信</button>
<button onclick="logout()">ログアウト</button>

<!-- 自分のパスワード変更 -->
<div style="margin-top:10px;">
<h4>パスワード変更（自分のみ）</h4>
<input type="password" id="newPass">
<button onclick="changeMyPass()">変更</button>
</div>

<!-- 管理者メニュー -->
<div id="adminMenu" style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
<h4>ユーザー管理（管理者専用）</h4>
<table border="1" cellpadding="3">
<tr><th>名前</th><th>職制</th><th>パスワード</th><th>操作</th></tr>
<tbody id="userTable"></tbody>
</table>
<h5>新規ユーザー追加</h5>
名前: <input id="newName">
職制: 
<select id="newRole">
<option>管理者</option>
<option>係長</option>
<option>機長班長</option>
<option>一般</option>
</select>
パスワード: <input id="newUserPass">
<button onclick="addUser()">追加</button>
</div>
</div>

<script>
let users = [
  {name:"山田利至", role:"管理者", pass:"1234"},
  {name:"倉田健太", role:"機長班長", pass:"1234"},
  {name:"安藤正樹", role:"係長", pass:"1234"},
  {name:"小林茂光", role:"機長班長", pass:"1234"}
];

let messages = [];
let currentUser = null;

const roleRank = {
  "管理者": 4,
  "係長": 3,
  "機長班長": 2,
  "一般": 1
};

function login(){
  let name = document.getElementById("loginName").value.trim();
  let pass = document.getElementById("loginPass").value.trim();
  let user = users.find(u=>u.name===name && u.pass===pass);
  if(user){
    currentUser = user;
    document.getElementById("loginScreen").style.display="none";
    document.getElementById("chatScreen").style.display="block";
    document.getElementById("currentUser").textContent = `${user.name}（${user.role}）`;

    // 管理者のみ管理メニュー表示
    if(user.role==="管理者"){
      document.getElementById("adminMenu").style.display="block";
      refreshUserTable();
    } else {
      document.getElementById("adminMenu").style.display="none";
    }

    showMessages();
  } else {
    alert("名前またはパスワードが違います");
  }
}

function logout(){
  currentUser = null;
  document.getElementById("loginScreen").style.display="block";
  document.getElementById("chatScreen").style.display="none";
  document.getElementById("loginName").value="";
  document.getElementById("loginPass").value="";
}

function sendMessage(){
  let text = document.getElementById("msgInput").value.trim();
  if(!text) return;
  messages.push({name:currentUser.name, role:currentUser.role, text});
  document.getElementById("msgInput").value="";
  showMessages();
}

function showMessages(){
  let div = document.getElementById("messages");
  div.innerHTML="";
  messages.forEach(m=>{
    // 自分の職制順位以上のみ表示
    if(roleRank[currentUser.role] >= roleRank[m.role]){
      let el = document.createElement("div");
      el.className="msg";
      el.innerHTML = `<b>${m.name}</b> <span class="role">(${m.role})</span>: ${m.text}`;
      div.appendChild(el);
    }
  });
  div.scrollTop = div.scrollHeight;
}

function changeMyPass(){
  let newP = document.getElementById("newPass").value.trim();
  if(!newP) { alert("パスワードを入力してください"); return; }
  currentUser.pass = newP;
  alert("パスワードを変更しました");
  document.getElementById("newPass").value="";
}

function refreshUserTable(){
  let tbody = document.getElementById("userTable");
  tbody.innerHTML="";
  users.forEach((u,i)=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `<td>${u.name}</td>
      <td><select onchange="changeRole(${i}, this.value)">
        <option ${u.role==="管理者"?"selected":""}>管理者</option>
        <option ${u.role==="係長"?"selected":""}>係長</option>
        <option ${u.role==="機長班長"?"selected":""}>機長班長</option>
        <option ${u.role==="一般"?"selected":""}>一般</option>
      </select></td>
      <td><input type="text" value="${u.pass}" onchange="changePass(${i}, this.value)"></td>
      <td><button onclick="deleteUser(${i})">削除</button></td>`;
    tbody.appendChild(tr);
  });
}

function changeRole(i, val){
  users[i].role = val;
}

function changePass(i, val){
  users[i].pass = val;
}

function deleteUser(i){
  if(confirm("削除しますか？")){
    users.splice(i,1);
    refreshUserTable();
  }
}

function addUser(){
  let name = document.getElementById("newName").value.trim();
  let role = document.getElementById("newRole").value;
  let pass = document.getElementById("newUserPass").value.trim();
  if(!name || !pass) { alert("名前とパスワードを入力してください"); return; }
  users.push({name, role, pass});
  document.getElementById("newName").value="";
  document.getElementById("newUserPass").value="";
  refreshUserTable();
}
</script>

</body>
</html>