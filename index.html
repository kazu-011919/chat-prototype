<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>生産部製造2課 チャット</title>
<style>
body { font-family: sans-serif; margin: 0; padding: 0; }
header { background: #2c3e50; color: white; padding: 10px; }
main { padding: 10px; }
select, input, button { margin: 5px; padding: 5px; }
#chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 5px; }
.message { border-bottom: 1px solid #ddd; padding: 3px; }
.system { color: gray; font-size: 0.9em; }
</style>
</head>
<body>

<header>
<h2>生産部製造2課 チャット</h2>
</header>

<main id="loginScreen">
<h3>ログイン</h3>
<label>名前:
<select id="loginName"></select>
</label><br>
<label>パスワード:
<input type="password" id="loginPass">
</label><br>
<button onclick="login()">ログイン</button>
</main>

<main id="chatScreen" style="display:none;">
<div>
<strong>ログイン中:</strong> <span id="currentUser"></span>
<button onclick="logout()">ログアウト</button>
</div>
<hr>
<div id="adminMenu" style="display:none;">
<h4>管理者メニュー</h4>
<button onclick="showUserList()">ユーザー一覧</button>
<div id="userListArea"></div>
</div>
<hr>
<select id="targetGroup">
<option value="一般">一般（全員）</option>
<option value="係長">係長以上</option>
<option value="機長班長">機長/班長以上</option>
<option value="管理者">管理者のみ</option>
</select>
<br>
<textarea id="messageInput" rows="3" cols="40"></textarea><br>
<button onclick="sendMessage()">送信</button>
<hr>
<div id="chat"></div>
</main>

<script>
let users = [
  {name:"山田利至", pass:"1234", role:"管理者"},
  {name:"倉田健太", pass:"1234", role:"機長班長"},
  {name:"安藤正樹", pass:"1234", role:"係長"},
  {name:"小林茂光", pass:"1234", role:"機長班長"},
  {name:"佐藤花子", pass:"1234", role:"係長"},
  {name:"高橋次郎", pass:"1234", role:"機長班長"},
  {name:"山田太郎", pass:"1234", role:"一般"}
];

let messages = [];
let currentUser = null;

const roleRank = {
  "管理者":4,
  "係長":3,
  "機長班長":2,
  "一般":1
};

function populateLoginNames(){
  let sel = document.getElementById("loginName");
  sel.innerHTML = "";
  users.forEach(u=>{
    let opt = document.createElement("option");
    opt.value = u.name;
    opt.textContent = u.name;
    sel.appendChild(opt);
  });
}
populateLoginNames();

function login(){
  let name = document.getElementById("loginName").value;
  let pass = document.getElementById("loginPass").value;
  let user = users.find(u=>u.name===name && u.pass===pass);
  if(user){
    currentUser = user;
    document.getElementById("loginScreen").style.display="none";
    document.getElementById("chatScreen").style.display="block";
    document.getElementById("currentUser").textContent = `${user.name}（${user.role}）`;
    if(user.role==="管理者"){
      document.getElementById("adminMenu").style.display="block";
    }
    showMessages();
  } else {
    alert("名前またはパスワードが違います");
  }
}

function logout(){
  currentUser = null;
  document.getElementById("loginScreen").style.display="block";
  document.getElementById("chatScreen").style.display="none";
  document.getElementById("loginPass").value="";
}

function sendMessage(){
  let text = document.getElementById("messageInput").value.trim();
  if(!text) return;
  let target = document.getElementById("targetGroup").value;
  messages.push({from:currentUser.name, role:currentUser.role, target:target, text:text, time:new Date().toLocaleString()});
  document.getElementById("messageInput").value="";
  showMessages();
}

function canViewMessage(msg){
  // 受信者の役職ランク >= メッセージ対象ランク
  return roleRank[currentUser.role] >= roleRank[msg.target];
}

function showMessages(){
  let chat = document.getElementById("chat");
  chat.innerHTML = "";
  messages.forEach(m=>{
    if(canViewMessage(m)){
      let div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong>${m.from}(${m.role}) → ${m.target}</strong> : ${m.text} <span class="system">[${m.time}]</span>`;
      chat.appendChild(div);
    }
  });
}

function showUserList(){
  let area = document.getElementById("userListArea");
  area.innerHTML = "";
  users.forEach((u,idx)=>{
    let div = document.createElement("div");
    div.innerHTML = `
      ${u.name} (${u.role}) 
      パス:<input type="text" value="${u.pass}" onchange="updatePass(${idx}, this.value)">
      役職:
      <select onchange="updateRole(${idx}, this.value)">
        <option value="管理者" ${u.role==="管理者"?"selected":""}>管理者</option>
        <option value="係長" ${u.role==="係長"?"selected":""}>係長</option>
        <option value="機長班長" ${u.role==="機長班長"?"selected":""}>機長/班長</option>
        <option value="一般" ${u.role==="一般"?"selected":""}>一般</option>
      </select>
    `;
    area.appendChild(div);
  });
}

function updatePass(index, newPass){
  users[index].pass = newPass;
}

function updateRole(index, newRole){
  users[index].role = newRole;
}
</script>

</body>
</html>