<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>生産部製造2課 チャット</title>
<style>
  body { font-family: Arial, sans-serif; }
  .hidden { display: none; }
  #chat-box { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 5px; }
  .admin-menu { margin-top: 10px; border: 1px solid #ccc; padding: 5px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 5px; }
</style>
</head>
<body>

<h2>生産部製造2課 チャット</h2>

<div id="login-screen">
  <select id="username">
    <option value="">名前を選択</option>
  </select><br>
  <input type="password" id="password" placeholder="パスワード"><br>
  <button onclick="login()">ログイン</button>
</div>

<div id="chat-screen" class="hidden">
  <p>ログイン中: <span id="current-user"></span>（<span id="current-role"></span>）</p>
  <div id="chat-box"></div>
  <select id="send-to">
    <option value="general">一般（全員）</option>
    <option value="kakaricho">係長</option>
    <option value="kicho-hancho">機長・班長</option>
  </select><br>
  <input type="text" id="message" placeholder="メッセージ"><br>
  <button onclick="sendMessage()">送信</button>

  <div id="admin-button" class="hidden">
    <button onclick="showAdminMenu()">管理者メニュー</button>
  </div>
</div>

<div id="admin-menu" class="hidden admin-menu">
  <h3>管理者メニュー</h3>
  <table>
    <tr><th>名前</th><th>職制</th><th>パスワード</th><th>操作</th></tr>
    <tbody id="user-list"></tbody>
  </table>
  <button onclick="closeAdminMenu()">閉じる</button>
</div>

<script>
// 職制順：管理者(0) → 係長(1) → 機長班長(2) → 一般(3)
const roleHierarchy = { "管理者": 0, "係長": 1, "機長班長": 2, "一般": 3 };

// ユーザー初期データ
let users = [
  { name: "山田利至", role: "管理者", password: "1234" },
  { name: "倉田健太", role: "機長班長", password: "1234" },
  { name: "安藤正樹", role: "係長", password: "1234" },
  { name: "小林茂光", role: "機長班長", password: "1234" },
  { name: "山田太郎", role: "一般", password: "1234" },
  { name: "佐藤花子", role: "係長", password: "1234" },
  { name: "高橋次郎", role: "機長班長", password: "1234" }
];

let currentUser = null;
let messages = [];

// 名前プルダウン生成
window.onload = function() {
  const select = document.getElementById("username");
  users.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u.name;
    opt.textContent = u.name;
    select.appendChild(opt);
  });
};

function login() {
  const name = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  const user = users.find(u => u.name === name && u.password === pass);
  if (user) {
    currentUser = user;
    document.getElementById("current-user").textContent = user.name;
    document.getElementById("current-role").textContent = user.role;
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("chat-screen").classList.remove("hidden");
    if (user.role === "管理者") {
      document.getElementById("admin-button").classList.remove("hidden");
    }
    renderMessages();
  } else {
    alert("名前またはパスワードが間違っています");
  }
}

function canViewMessage(msg) {
  return roleHierarchy[currentUser.role] <= roleHierarchy[msg.targetRole];
}

function sendMessage() {
  const text = document.getElementById("message").value;
  const target = document.getElementById("send-to").value;
  if (!text) return;

  let targetRole;
  if (target === "general") targetRole = "一般";
  else if (target === "kakaricho") targetRole = "係長";
  else targetRole = "機長班長";

  messages.push({ sender: currentUser.name, targetRole, text });
  document.getElementById("message").value = "";
  renderMessages();
}

function renderMessages() {
  const box = document.getElementById("chat-box");
  box.innerHTML = "";
  messages.forEach(msg => {
    if (canViewMessage(msg)) {
      const div = document.createElement("div");
      div.textContent = `[${msg.sender} → ${msg.targetRole}] ${msg.text}`;
      box.appendChild(div);
    }
  });
}

function showAdminMenu() {
  const list = document.getElementById("user-list");
  list.innerHTML = "";
  users.forEach((u, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.name}</td>
      <td>${u.role}</td>
      <td><input type="text" value="${u.password}" onchange="updatePassword(${idx}, this.value)"></td>
      <td><button onclick="deleteUser(${idx})">削除</button></td>
    `;
    list.appendChild(tr);
  });
  document.getElementById("admin-menu").classList.remove("hidden");
}

function closeAdminMenu() {
  document.getElementById("admin-menu").classList.add("hidden");
}

function updatePassword(index, newPass) {
  users[index].password = newPass;
}

function deleteUser(index) {
  if (confirm("削除しますか？")) {
    users.splice(index, 1);
    showAdminMenu();
  }
}
</script>
</body>
</html>
