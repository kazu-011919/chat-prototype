<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è£½é€ 2èª²ãƒãƒ£ãƒƒãƒˆï¼ˆæœ€æ–°ç‰ˆãƒ»åˆæœŸãƒ‘ã‚¹1234ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f4f6f8;color:#222}
  header{background:#0b63c5;color:#fff;padding:12px 16px}
  main{padding:12px;display:flex;gap:12px;flex-wrap:wrap}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
  #left{width:320px;min-width:260px}
  #center{flex:1;min-width:300px}
  #right{width:320px;min-width:260px}
  select,input,textarea,button{width:100%;box-sizing:border-box;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
  button{background:#0b63c5;color:#fff;border:none}
  .muted{color:#666;font-size:13px}
  .messages{height:420px;overflow:auto;padding:8px;border-radius:6px;border:1px solid #eee;background:#fafafa}
  .msg{padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #eee;background:#fff}
  .meta{font-size:12px;color:#666;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;color:#fff;font-size:12px}
  .badge.admin{background:#6f42c1}
  .badge.kacho{background:#28a745}
  .badge.kicho{background:#dc3545}
  .badge.general{background:#007bff}
  .small{font-size:12px;color:#555}
  .admin-table{width:100%;border-collapse:collapse}
  .admin-table th,.admin-table td{border:1px solid #eee;padding:6px}
  .link-btn{background:#fff;color:#0b63c5;border:1px solid #0b63c5;padding:6px;border-radius:6px}
  a.file-link{color:#0b63c5;text-decoration:none;display:block;margin-top:6px}
</style>
</head>
<body>
<header><h1>è£½é€ 2èª²ãƒãƒ£ãƒƒãƒˆ â€” è©¦ä½œï¼ˆåˆæœŸãƒ‘ã‚¹ 1234ï¼‰</h1></header>

<main>
  <!-- å·¦ï¼šãƒ­ã‚°ã‚¤ãƒ³ / ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <section id="left" class="card">
    <h3>ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <label>è·åˆ¶</label>
    <select id="role-select"><option value="">-- é¸æŠ --</option></select>

    <label>æ°å</label>
    <select id="name-select" disabled><option>è·åˆ¶ã‚’é¸ã‚“ã§ãã ã•ã„</option></select>

    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
    <input id="login-pass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ•°å­—ã®ã¿ã‚‚å¯ï¼‰" />

    <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div id="login-info" class="muted">ç®¡ç†è€…ï¼šå±±ç”°åˆ©è‡³ / ä¿‚é•·ï¼šå®‰è—¤æ­£æ¨¹ / æ©Ÿé•·ç­é•·ï¼šå°æ—èŒ‚å…‰ / ä¸€èˆ¬ï¼šå€‰ç”°å¥å¤ª</div>

    <hr />
    <h3>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
    <ul id="calendar-list" class="muted"></ul>

    <div id="cal-admin" style="display:none">
      <h4>äºˆå®šè¿½åŠ ï¼ˆç®¡ç†è€…ï¼‰</h4>
      <input id="cal-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
      <input id="cal-until" placeholder="æœŸé™ (YYYY-MM-DD)" />
      <button id="cal-add" class="link-btn">è¿½åŠ </button>
    </div>
  </section>

  <!-- ä¸­å¤®ï¼šãƒãƒ£ãƒƒãƒˆ -->
  <section id="center" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="logged-info" class="small">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
      <div id="logout-wrap" style="display:none">
        <button id="logout-btn" class="link-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>

    <hr />
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label style="width:40%">é…ä¿¡å…ˆ</label>
      <select id="target-select" style="width:60%">
        <option value="general">ä¸€èˆ¬ï¼ˆå…¨å“¡ï¼‰</option>
        <option value="kacho">ä¿‚é•·</option>
        <option value="kicho">æ©Ÿé•·ç­é•·</option>
      </select>
    </div>

    <div id="messages" class="messages"></div>

    <div style="margin-top:8px">
      <textarea id="msg-text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" rows="3"></textarea>
      <input id="file-input" type="file" accept=".pdf,image/*" />
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="send-btn">é€ä¿¡</button>
        <button id="clear-btn" class="link-btn">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ¶ˆå»</button>
        <button id="my-pass-btn" class="link-btn" style="display:none">è‡ªåˆ†ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
      </div>
    </div>
  </section>

  <!-- å³ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ / ç®¡ç†è€… -->
  <aside id="right" class="card">
    <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h3>
    <div id="user-list" class="muted"></div>
    <hr />
    <div id="admin-panel" style="display:none">
      <h3>ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
      <div style="margin-bottom:8px">
        <input id="new-name" placeholder="æ°å" />
        <select id="new-role">
          <option value="general">ä¸€èˆ¬</option>
          <option value="kicho">æ©Ÿé•·ç­é•·</option>
          <option value="kacho">ä¿‚é•·</option>
          <option value="admin">ç®¡ç†è€…</option>
        </select>
        <input id="new-pass" placeholder="åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„ã€æœªå…¥åŠ›ã¯1234)" />
        <button id="add-user-btn">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ </button>
      </div>

      <div style="max-height:260px;overflow:auto">
        <table class="admin-table">
          <thead><tr><th>åå‰</th><th>è·åˆ¶</th><th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="admin-user-table"></tbody>
        </table>
      </div>
    </div>
  </aside>
</main>

<script>
/* ====== ãƒ‡ãƒ¼ã‚¿å®šç¾© & åˆæœŸåŒ– ====== */
const LS_USERS = 'chat_users_v4';
const LS_MSGS  = 'chat_msgs_v4';
const LS_CAL   = 'chat_cal_v4';

// åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã”æŒ‡å®šæ§‹æˆï¼‰ â€” å…¨å“¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ '1234'
const defaultUsers = [
  {id:'u_admin', name:'å±±ç”°åˆ©è‡³', role:'admin', password:'1234'},
  {id:'u_kicho', name:'å°æ—èŒ‚å…‰', role:'kicho', password:'1234'},
  {id:'u_kacho', name:'å®‰è—¤æ­£æ¨¹', role:'kacho', password:'1234'},
  {id:'u_general', name:'å€‰ç”°å¥å¤ª', role:'general', password:'1234'}
];

// åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
const defaultCal = [{id:'ev1', title:'å¯¾ç­–æ›¸ä½œæˆ', until:'2025-08-30'}];

// å½¹è·ãƒ©ãƒ³ã‚¯ï¼ˆæ•°å€¤ãŒå¤§ãã„ã»ã©ä¸Šä½ï¼‰
const roleRank = { admin:4, kacho:3, kicho:2, bancho:2, general:1 };

// åˆæœŸåŒ–ï¼ˆlocalStorageã«ç„¡ã‘ã‚Œã°æŠ•å…¥ï¼‰
function init(){
  if(!localStorage.getItem(LS_USERS)) localStorage.setItem(LS_USERS, JSON.stringify(defaultUsers));
  if(!localStorage.getItem(LS_MSGS))  localStorage.setItem(LS_MSGS, JSON.stringify([]));
  if(!localStorage.getItem(LS_CAL))   localStorage.setItem(LS_CAL, JSON.stringify(defaultCal));
}
init();

/* ====== çŠ¶æ…‹å¤‰æ•° ====== */
let users = JSON.parse(localStorage.getItem(LS_USERS));
let messages = JSON.parse(localStorage.getItem(LS_MSGS));
let calendar = JSON.parse(localStorage.getItem(LS_CAL));
let currentUser = null;

/* ====== DOM å‚ç…§ ====== */
const roleSelect = document.getElementById('role-select');
const nameSelect = document.getElementById('name-select');
const loginPass = document.getElementById('login-pass');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loggedInfo = document.getElementById('logged-info');
const messagesDiv = document.getElementById('messages');
const targetSelect = document.getElementById('target-select');
const msgText = document.getElementById('msg-text');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const userListDiv = document.getElementById('user-list');
const adminPanel = document.getElementById('admin-panel');
const adminUserTable = document.getElementById('admin-user-table');
const addUserBtn = document.getElementById('add-user-btn');
const newName = document.getElementById('new-name');
const newRole = document.getElementById('new-role');
const newPass = document.getElementById('new-pass');
const calendarList = document.getElementById('calendar-list');
const calAdmin = document.getElementById('cal-admin');
const calAdd = document.getElementById('cal-add');
const calTitle = document.getElementById('cal-title');
const calUntil = document.getElementById('cal-until');
const logoutWrap = document.getElementById('logout-wrap');
const myPassBtn = document.getElementById('my-pass-btn');
const clearBtn = document.getElementById('clear-btn');

/* ====== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ====== */
function saveUsers(){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
function saveMsgs(){ localStorage.setItem(LS_MSGS, JSON.stringify(messages)); }
function saveCal(){ localStorage.setItem(LS_CAL, JSON.stringify(calendar)); }
function roleLabel(key){
  if(key==='admin') return 'ç®¡ç†è€…';
  if(key==='kacho') return 'ä¿‚é•·';
  if(key==='kicho' || key==='bancho') return 'æ©Ÿé•·ç­é•·';
  return 'ä¸€èˆ¬';
}
function targetRankFromValue(val){
  if(val==='general') return 1;
  if(val==='kicho') return 2;
  if(val==='kacho') return 3;
  return 1;
}

/* ====== UI åˆæœŸæç”» ====== */
function refreshRoleOptions(){
  roleSelect.innerHTML = '<option value="">-- é¸æŠ --</option>';
  const labels = {admin:'ç®¡ç†è€…', kacho:'ä¿‚é•·', kicho:'æ©Ÿé•·ç­é•·', general:'ä¸€èˆ¬'};
  const seen = new Set();
  ['admin','kacho','kicho','general'].forEach(k=>{
    if(!seen.has(k)){ seen.add(k); const opt = document.createElement('option'); opt.value = k; opt.textContent = labels[k]; roleSelect.appendChild(opt); }
  });
}
function refreshNameOptionsForRole(roleKey){
  nameSelect.innerHTML = '';
  const filtered = users.filter(u=>u.role === roleKey);
  if(filtered.length===0){ const opt = document.createElement('option'); opt.textContent = 'è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“'; nameSelect.appendChild(opt); nameSelect.disabled=true; return; }
  filtered.forEach(u=>{ const opt=document.createElement('option'); opt.value=u.id; opt.textContent=u.name; nameSelect.appendChild(opt); });
  nameSelect.disabled=false;
}
function renderUserList(){ userListDiv.innerHTML=''; users.forEach(u=>{ const p=document.createElement('p'); p.textContent = `${u.name}ï¼ˆ${roleLabel(u.role)}ï¼‰`; userListDiv.appendChild(p); }); }
function renderCalendar(){ calendar = JSON.parse(localStorage.getItem(LS_CAL)||'[]'); calendarList.innerHTML=''; calendar.forEach(ev=>{ const li=document.createElement('li'); li.textContent = ev.title + ' ã€œ ' + ev.until; calendarList.appendChild(li); }); }
function renderAdminTable(){
  adminUserTable.innerHTML=''; users.forEach((u,idx)=>{
    const tr = document.createElement('tr');
    const nameTd = document.createElement('td'); nameTd.textContent = u.name;
    const roleTd = document.createElement('td');
    const roleSel = document.createElement('select');
    [['admin','ç®¡ç†è€…'],['kacho','ä¿‚é•·'],['kicho','æ©Ÿé•·ç­é•·'],['general','ä¸€èˆ¬']].forEach(([val,label])=>{
      const o=document.createElement('option'); o.value=val; o.textContent=label; if(u.role===val) o.selected=true; roleSel.appendChild(o);
    });
    roleSel.onchange = ()=>{ users[idx].role = roleSel.value; saveUsers(); refreshUI(); };
    roleTd.appendChild(roleSel);

    const passTd = document.createElement('td');
    const passIn = document.createElement('input'); passIn.type='text'; passIn.value=u.password;
    passIn.onchange = ()=>{ users[idx].password = passIn.value; saveUsers(); refreshUI(); };
    passTd.appendChild(passIn);

    const opTd = document.createElement('td');
    const delBtn = document.createElement('button'); delBtn.textContent='å‰Šé™¤'; delBtn.className='link-btn';
    delBtn.onclick = ()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ users.splice(idx,1); saveUsers(); refreshUI(); } };
    opTd.appendChild(delBtn);

    tr.appendChild(nameTd); tr.appendChild(roleTd); tr.appendChild(passTd); tr.appendChild(opTd);
    adminUserTable.appendChild(tr);
  });
}

/* ====== åˆæœŸ setup ====== */
function refreshUI(){
  users = JSON.parse(localStorage.getItem(LS_USERS)||'[]');
  messages = JSON.parse(localStorage.getItem(LS_MSGS)||'[]');
  calendar = JSON.parse(localStorage.getItem(LS_CAL)||'[]');
  refreshRoleOptions();
  renderUserList();
  renderCalendar();
  if(currentUser){
    document.getElementById('logged-info').textContent = currentUser.name + 'ï¼ˆ' + roleLabel(currentUser.role) + 'ï¼‰';
    if(currentUser.role==='admin'){ adminPanel.style.display='block'; calAdmin.style.display='block'; renderAdminTable(); } else { adminPanel.style.display='none'; calAdmin.style.display='none'; }
    logoutWrap.style.display = 'block';
    myPassBtn.style.display = 'inline-block';
  } else {
    document.getElementById('logged-info').textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
    adminPanel.style.display='none'; calAdmin.style.display='none'; logoutWrap.style.display='none'; myPassBtn.style.display='none';
  }
  renderMessages();
}
refreshUI();

/* ====== ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆè·åˆ¶â†’æ°åäºŒæ®µéšï¼‰ ====== */
roleSelect.addEventListener('change', ()=>{
  const r = roleSelect.value;
  if(!r){ nameSelect.innerHTML='<option>è·åˆ¶ã‚’é¸ã‚“ã§ãã ã•ã„</option>'; nameSelect.disabled=true; return; }
  refreshNameOptionsForRole(r);
});

loginBtn.addEventListener('click', ()=>{
  const uid = nameSelect.value;
  const pw = loginPass.value;
  if(!uid){ alert('æ°åã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const u = users.find(x=>x.id===uid);
  if(!u){ alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  if(u.password !== pw){ alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
  currentUser = u;
  // set UI
  document.getElementById('logged-info').textContent = currentUser.name + 'ï¼ˆ' + roleLabel(currentUser.role) + 'ï¼‰';
  document.getElementById('left').style.display = 'none';
  document.getElementById('center').style.display = 'block';
  document.getElementById('right').style.display = 'block';
  logoutWrap.style.display = 'block';
  if(currentUser.role === 'admin'){ adminPanel.style.display='block'; calAdmin.style.display='block'; renderAdminTable(); }
  else { adminPanel.style.display='none'; calAdmin.style.display='none'; }
  myPassBtn.style.display = 'inline-block';
  renderMessages();
});

/* ====== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ====== */
logoutBtn.addEventListener('click', ()=>{
  currentUser = null;
  document.getElementById('left').style.display='block';
  document.getElementById('center').style.display='block';
  document.getElementById('right').style.display='block';
  loginPass.value=''; nameSelect.innerHTML=''; roleSelect.value='';
  refreshUI();
});

/* ====== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ / è¡¨ç¤º / æ—¢èª­ ====== */
function canUserSendTo(targetVal){
  if(!currentUser) return false;
  const userRank = roleRank[currentUser.role] || 1;
  const trgRank = targetRankFromValue(targetVal);
  return userRank >= trgRank;
}
sendBtn.addEventListener('click', async ()=>{
  if(!currentUser){ alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  const text = msgText.value.trim();
  const targetVal = targetSelect.value;
  if(!text && !(fileInput.files && fileInput.files.length>0)){ alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹æ·»ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!canUserSendTo(targetVal)){ alert('ã“ã®é…ä¿¡å…ˆã«ã¯é€ä¿¡ã§ãã¾ã›ã‚“'); return; }
  let fileObj = null;
  if(fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    if(f.size > 10*1024*1024){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„'); return; }
    fileObj = await new Promise(res=>{
      const fr = new FileReader(); fr.onload = ()=> res({name:f.name,data:fr.result,type:f.type}); fr.readAsDataURL(f);
    });
  }
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const id = 'm' + Date.now();
  const m = { id, senderId: currentUser.id, senderName: currentUser.name, senderRole: currentUser.role, target: targetVal, text, time: new Date().toISOString(), file: fileObj, readBy: [] };
  msgs.push(m); localStorage.setItem(LS_MSGS, JSON.stringify(msgs)); msgText.value=''; fileInput.value=''; messages = msgs;
  renderMessages();
});

function renderMessages(){
  messages = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  messagesDiv.innerHTML = '';
  if(!currentUser) return;
  const userRank = roleRank[currentUser.role] || 1;
  messages.forEach(m=>{
    const trgRank = targetRankFromValue(m.target);
    if(userRank < trgRank) return; // è¦‹ã‚Œãªã„
    const div = document.createElement('div'); div.className='msg';
    const meta = document.createElement('div'); meta.className='meta';
    const badge = document.createElement('span'); badge.className='badge ' + (m.senderRole==='admin'?'admin':(m.target==='kacho'?'kacho':(m.target==='kicho'?'kicho':'general')));
    badge.textContent = roleLabel(m.senderRole);
    meta.appendChild(badge);
    const leftText = document.createElement('span'); leftText.style.marginLeft='8px';
    leftText.innerHTML = `<strong>${m.senderName}</strong>ã€€${new Date(m.time).toLocaleString()}`;
    meta.appendChild(leftText);

    const rightActions = document.createElement('div');
    rightActions.className='right-actions';
    const readInfo = document.createElement('span'); readInfo.className='small'; readInfo.textContent = 'æ—¢èª­ï¼š' + ((m.readBy && m.readBy.length) || 0) + 'äºº';
    rightActions.appendChild(readInfo);
    if(currentUser && currentUser.role === 'admin'){
      const rb = document.createElement('button'); rb.className='link-btn'; rb.textContent='æ—¢èª­è€…è¡¨ç¤º';
      rb.onclick = ()=>{ const names=(m.readBy||[]).map(id=>{ const u=users.find(x=>x.id===id); return u?u.name:id; }); alert('æ—¢èª­è€…:\n' + (names.length?names.join('\n'):'ãªã—')); };
      rightActions.appendChild(rb);
    }
    meta.appendChild(rightActions);
    div.appendChild(meta);

    if(m.text) { const t = document.createElement('div'); t.textContent = m.text; div.appendChild(t); }
    if(m.file){
      const a = document.createElement('a'); a.href = m.file.data; a.download = m.file.name; a.className='file-link';
      a.textContent = 'ğŸ“ ' + m.file.name + 'ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰';
      div.appendChild(a);
    }
    messagesDiv.appendChild(div);
    // mark read
    markRead(m.id);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function markRead(msgId){
  if(!currentUser) return;
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const m = msgs.find(x=>x.id===msgId);
  if(!m) return;
  if(!m.readBy) m.readBy=[];
  if(!m.readBy.includes(currentUser.id)){
    m.readBy.push(currentUser.id);
    localStorage.setItem(LS_MSGS, JSON.stringify(msgs));
  }
}

/* ====== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç®¡ç†è€…ã¯ä»–äººç·¨é›†ã€è‡ªåˆ†ã¯è‡ªåˆ†ã§å¤‰æ›´ï¼‰ ====== */
myPassBtn.addEventListener('click', ()=>{
  if(!currentUser) return alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
  const np = prompt('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ•°å­—ã®ã¿ã§ã‚‚å¯ï¼‰:');
  if(!np) return;
  const idx = users.findIndex(u=>u.id===currentUser.id);
  if(idx>=0){ users[idx].password = np; saveUsers(); alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ'); refreshUI(); }
});

/* ====== ç®¡ç†è€…ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ /ç·¨é›†/å‰Šé™¤ ====== */
addUserBtn.addEventListener('click', ()=>{
  if(!currentUser || currentUser.role !== 'admin') return alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™');
  const name = newName.value.trim(); const role = newRole.value; let pass = newPass.value.trim();
  if(!name) { alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!pass) pass = '1234'; // default initial password
  const id = 'u' + Date.now();
  users.push({id,name,role,password:pass});
  saveUsers(); newName.value=''; newPass.value=''; refreshUI();
});

/* ====== ç®¡ç†è€… UI ã®ç·¨é›†æ“ä½œï¼ˆrenderAdminTable ã® inputs ã§ä¿å­˜æ¸ˆã¿ï¼‰ ====== */
/* renderAdminTable already binds onchange handlers to update users and saveUsers */

/* ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¿½åŠ ï¼ˆç®¡ç†è€…ï¼‰ ====== */
calAdd.addEventListener('click', ()=>{
  if(!currentUser || currentUser.role!=='admin') return alert('ç®¡ç†è€…ã®ã¿è¿½åŠ å¯èƒ½');
  const t = calTitle.value.trim(); const u = calUntil.value.trim();
  if(!t || !u) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨æœŸé™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  calendar.push({id:'ev'+Date.now(), title:t, until:u});
  saveCal(); calTitle.value=''; calUntil.value=''; renderCalendar();
});

/* ====== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ¶ˆå»ï¼ˆç¢ºèªã‚ã‚Šï¼‰ ====== */
clearBtn.addEventListener('click', ()=>{
  if(!confirm('ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸå…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.setItem(LS_MSGS, JSON.stringify([])); messages = []; renderMessages();
});

/* ====== åˆæœŸUIçŠ¶æ…‹èª¿æ•´ ====== */
(function prepareInitialUI(){
  // show left panel, center/right exist but content updates on login
  refreshUI();
})();

</script>
</body>
</html>
