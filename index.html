<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>製造2課チャット（試作 完全版）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:#f4f6f8;color:#222}
  header{background:#0b63c5;color:#fff;padding:12px 16px}
  main{padding:12px;display:flex;gap:12px;flex-wrap:wrap}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
  #left{width:320px;min-width:260px}
  #center{flex:1;min-width:260px}
  #right{width:260px;min-width:200px}
  select,input,textarea,button{width:100%;box-sizing:border-box;padding:8px;margin:6px 0;border:1px solid #ddd;border-radius:6px}
  button{background:#0b63c5;color:#fff;border:none}
  .muted{color:#666;font-size:13px}
  .messages{height:420px;overflow:auto;padding:8px;border-radius:6px;border:1px solid #eee;background:#fafafa}
  .msg{padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #eee;background:#fff}
  .meta{font-size:12px;color:#666;margin-bottom:6px}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;color:#fff;font-size:12px}
  .badge.admin{background:#6f42c1}
  .badge.kacho{background:#28a745}
  .badge.kicho{background:#dc3545}
  .badge.general{background:#007bff}
  .small{font-size:12px;color:#555}
  .admin-row{display:flex;gap:8px;align-items:center}
  .file-link{display:block;margin-top:6px;color:#0b63c5;text-decoration:none}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #eee;padding:6px;text-align:left;font-size:13px}
  .right-actions{display:flex;gap:6px}
  .link-btn{background:#fff;color:#0b63c5;border:1px solid #0b63c5;padding:6px;border-radius:6px}
</style>
</head>
<body>
<header>
  <h1>製造2課チャット（試作 完全版）</h1>
</header>

<main>
  <!-- 左：ログイン／カレンダー -->
  <section id="left" class="card">
    <h3>ログイン</h3>
    <label>名前（選択）</label>
    <select id="login-select"></select>
    <label>パスワード</label>
    <input id="login-pass" type="password" placeholder="初期パスワード（数字のみ可）" />
    <button id="login-btn">ログイン</button>
    <p class="muted">初期ユーザー：管理者・係長・機長班長・一般が登録済み</p>
    <hr />
    <h3>カレンダー</h3>
    <ul id="calendar-list" class="muted"></ul>
    <div id="calendar-admin" style="display:none">
      <hr />
      <h4>予定追加（管理者のみ）</h4>
      <input id="cal-title" placeholder="タイトル(例: 対策書作成)" />
      <input id="cal-until" placeholder="期限 (YYYY-MM-DD) 例: 2025-08-30" />
      <button id="cal-add">追加</button>
    </div>
  </section>

  <!-- 中央：チャット -->
  <section id="center" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="logged-info" class="small">未ログイン</div>
      </div>
      <div id="logout-area" style="display:none">
        <button id="logout-btn" class="link-btn">ログアウト</button>
      </div>
    </div>

    <hr />
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label style="width:40%">配信先</label>
      <select id="target-select" style="width:60%">
        <option value="general">一般（全員）</option>
        <option value="kacho">係長</option>
        <option value="kicho">機長・班長</option>
      </select>
    </div>

    <div id="messages" class="messages"></div>

    <div style="margin-top:8px">
      <textarea id="msg-text" placeholder="メッセージを入力" rows="3"></textarea>
      <input id="file-input" type="file" accept=".pdf,image/*" />
      <div style="display:flex;gap:8px">
        <button id="send-btn">送信</button>
        <button id="clear-btn" class="link-btn">クリア</button>
      </div>
    </div>
  </section>

  <!-- 右：ユーザー一覧 / 管理者メニュー -->
  <aside id="right" class="card">
    <h3>ユーザー一覧</h3>
    <div id="user-list" class="muted"></div>
    <hr />
    <div id="admin-panel" style="display:none">
      <h3>管理者メニュー</h3>
      <div style="margin-bottom:8px">
        <input id="new-name" placeholder="氏名" />
        <select id="new-role">
          <option value="general">一般</option>
          <option value="kicho">機長班長</option>
          <option value="kacho">係長</option>
          <option value="admin">管理者</option>
        </select>
        <input id="new-pass" placeholder="初期パスワード(4-12)" />
        <button id="add-user-btn">ユーザー追加</button>
      </div>
      <div>
        <table>
          <thead><tr><th>名前</th><th>職制</th><th>パスワード</th><th>操作</th></tr></thead>
          <tbody id="admin-user-table"></tbody>
        </table>
      </div>
    </div>
  </aside>
</main>

<script>
/*
  完全部署チャット（PWA試作版） - 単一ファイル
  機能:
  - 職制順: 管理者 > 係長 > 機長班長 > 一般
  - 自分の職制と下位の投稿を閲覧可能（userRank >= targetRank）
  - 管理者によるユーザー一覧表示・パスワードの表示編集・追加・削除
  - PDF / 画像添付（Data URLでlocalStorage保存）→ ダウンロード可能
  - カレンダー（管理者は追加可）、初期イベント「対策書作成 2025-08-30」
  - 既読管理（メッセージ毎に既読配列を保持）, 管理者は既読者一覧を確認可
  - 永続化：localStorage 使用（端末単位）
*/

const LS_USERS = 'chatv2_users';
const LS_MSGS = 'chatv2_msgs';
const LS_CAL = 'chatv2_cal';

// 初期データ（保存されていなければ投入）
const defaultUsers = [
  {id:'u_admin', name:'山田利至', role:'admin', password:'admin123'},
  {id:'u_kicho', name:'倉田健太', role:'kicho', password:'kenta2025'},
  {id:'u_kacho', name:'安藤正樹', role:'kacho', password:'ando1234'},
  {id:'u_bancho', name:'小林茂光', role:'kicho', password:'kobayashi1'},
  {id:'u_general', name:'山田太郎', role:'general', password:'user1234'}
];

const defaultCal = [
  {id:'ev1', title:'対策書作成', until:'2025-08-30'}
];

// role rank: higher number = more authority
const roleRank = { admin:4, kacho:3, kicho:2, bancho:2, general:1 };

// restore or init
function initStorage(){
  if(!localStorage.getItem(LS_USERS)) localStorage.setItem(LS_USERS, JSON.stringify(defaultUsers));
  if(!localStorage.getItem(LS_MSGS)) localStorage.setItem(LS_MSGS, JSON.stringify([]));
  if(!localStorage.getItem(LS_CAL)) localStorage.setItem(LS_CAL, JSON.stringify(defaultCal));
}
initStorage();

let users = JSON.parse(localStorage.getItem(LS_USERS));
let messages = JSON.parse(localStorage.getItem(LS_MSGS));
let calendar = JSON.parse(localStorage.getItem(LS_CAL));
let currentUser = null;

// DOM refs
const loginSelect = document.getElementById('login-select');
const loginPass = document.getElementById('login-pass');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loggedInfo = document.getElementById('logged-info');
const messagesDiv = document.getElementById('messages');
const targetSelect = document.getElementById('target-select');
const msgText = document.getElementById('msg-text');
const sendBtn = document.getElementById('send-btn');
const fileInput = document.getElementById('file-input');
const userListDiv = document.getElementById('user-list');
const adminPanel = document.getElementById('admin-panel');
const adminUserTable = document.getElementById('admin-user-table');
const addUserBtn = document.getElementById('add-user-btn');
const newName = document.getElementById('new-name');
const newRole = document.getElementById('new-role');
const newPass = document.getElementById('new-pass');
const calendarList = document.getElementById('calendar-list');
const calAdmin = document.getElementById('calendar-admin');
const calAdd = document.getElementById('cal-add');
const calTitle = document.getElementById('cal-title');
const calUntil = document.getElementById('cal-until');
const adminMenuWrap = document.getElementById('admin-panel');

// populate login select & user list
function refreshUsers(){
  users = JSON.parse(localStorage.getItem(LS_USERS) || '[]');
  loginSelect.innerHTML = '<option value="">-- 選択 --</option>';
  userListDiv.innerHTML = '';
  users.forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.id;
    opt.textContent = u.name + '（' + roleLabel(u.role) + '）';
    loginSelect.appendChild(opt);

    const p = document.createElement('p');
    p.textContent = u.name + '（' + roleLabel(u.role) + '）';
    userListDiv.appendChild(p);
  });
  // admin table
  renderAdminTable();
}
function roleLabel(r){
  if(r==='admin') return '管理者';
  if(r==='kacho') return '係長';
  if(r==='kicho' || r==='bancho') return '機長班長';
  return '一般';
}
refreshUsers();
renderCalendar();

// login
loginBtn.addEventListener('click', ()=>{
  const uid = loginSelect.value;
  const pass = loginPass.value;
  if(!uid){ alert('名前を選択してください'); return; }
  const u = users.find(x=>x.id===uid);
  if(!u){ alert('ユーザーが見つかりません'); return; }
  if(u.password !== pass){ alert('パスワードが違います'); return; }
  currentUser = u;
  onLogin();
});

// logout
logoutBtn.addEventListener('click', ()=>{
  location.reload();
});

function onLogin(){
  document.getElementById('logged-info').textContent = currentUser.name + '（' + roleLabel(currentUser.role) + '）';
  document.getElementById('logout-area').style.display = 'block';
  document.getElementById('login-select').disabled = true;
  document.getElementById('login-pass').disabled = true;
  loginBtn.disabled = true;
  // admin panel visibility
  if(currentUser.role === 'admin'){
    adminPanel.style.display = 'block';
    calAdmin.style.display = 'block';
  } else {
    adminPanel.style.display = 'none';
    calAdmin.style.display = 'none';
  }
  renderMessages();
}

// permission logic: userRank >= targetRank allows view/send
function targetRankFromValue(val){
  if(val === 'general') return 1;
  if(val === 'kicho') return 2;
  if(val === 'kacho') return 3;
  return 1;
}
function canUserViewMsg(msg){
  if(!currentUser) return false;
  const userRank = roleRank[currentUser.role] || roleRank['general'];
  const trgRank = targetRankFromValue(msg.target);
  return userRank >= trgRank;
}
function canUserSendTo(targetVal){
  if(!currentUser) return false;
  const userRank = roleRank[currentUser.role] || roleRank['general'];
  const trgRank = targetRankFromValue(targetVal);
  return userRank >= trgRank;
}

// send message
sendBtn.addEventListener('click', async ()=>{
  if(!currentUser){ alert('ログインしてください'); return; }
  const text = msgText.value.trim();
  const targetVal = targetSelect.value;
  if(!canUserSendTo(targetVal)){ alert('この配信先には送信できません'); return; }
  let fileObj = null;
  if(fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    // limit size simple check (10MB)
    if(f.size > 10*1024*1024){ alert('ファイルは10MB以下にしてください'); return; }
    fileObj = await fileToDataURL(f);
  }
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const id = 'm' + Date.now();
  const m = { id, senderId: currentUser.id, senderName: currentUser.name, senderRole: currentUser.role, target: targetVal, text, time: new Date().toISOString(), file: fileObj, readBy: [] };
  msgs.push(m);
  localStorage.setItem(LS_MSGS, JSON.stringify(msgs));
  msgText.value=''; fileInput.value='';
  messages = msgs;
  renderMessages();
});

// file to dataURL
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res({name:file.name,data:fr.result,type:file.type});
    fr.onerror = ()=> rej();
    fr.readAsDataURL(file);
  });
}

// render messages
function renderMessages(){
  messages = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  messagesDiv.innerHTML = '';
  messages.forEach(m=>{
    if(!canUserViewMsg(m)) return;
    const div = document.createElement('div'); div.className='msg';
    const meta = document.createElement('div'); meta.className='meta';
    const badge = document.createElement('span'); badge.className='badge ' + (m.senderRole==='admin'?'admin':(m.target==='kacho'?'kacho':(m.target==='kicho'?'kicho':'general')));
    badge.textContent = roleLabel(m.senderRole);
    meta.innerHTML = `<strong>${m.senderName}</strong> `;
    meta.prepend(badge);
    meta.innerHTML += '　' + new Date(m.time).toLocaleString();
    div.appendChild(meta);
    const txt = document.createElement('div'); txt.textContent = m.text; div.appendChild(txt);
    if(m.file){
      const a = document.createElement('a');
      a.href = m.file.data;
      a.download = m.file.name;
      a.className = 'file-link';
      a.textContent = '📎 ' + m.file.name + ' （ダウンロード）';
      div.appendChild(a);
    }
    const readInfo = document.createElement('div'); readInfo.className='small';
    readInfo.textContent = '既読：' + (m.readBy?m.readBy.length:0) + ' 人';
    // admin: 詳細見るボタン
    if(currentUser && currentUser.role === 'admin'){
      const btn = document.createElement('button');
      btn.textContent = '既読者を表示';
      btn.style.marginLeft='8px';
      btn.className='link-btn';
      btn.onclick = ()=> { showReadDetail(m.id); };
      readInfo.appendChild(btn);
    }
    div.appendChild(readInfo);
    messagesDiv.appendChild(div);
    // mark read for this user
    markRead(m.id);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// mark read: add currentUser.id to message.readBy
function markRead(msgId){
  if(!currentUser) return;
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const m = msgs.find(x=>x.id === msgId);
  if(!m) return;
  if(!m.readBy) m.readBy = [];
  if(!m.readBy.includes(currentUser.id)){
    m.readBy.push(currentUser.id);
    localStorage.setItem(LS_MSGS, JSON.stringify(msgs));
  }
  // update visual count if needed
  // (re-rendering will show updated counts)
}

// admin: show read detail
function showReadDetail(msgId){
  const msgs = JSON.parse(localStorage.getItem(LS_MSGS) || '[]');
  const m = msgs.find(x=>x.id===msgId);
  if(!m) return alert('メッセージが見つかりません');
  const names = (m.readBy||[]).map(id=>{ const u=users.find(x=>x.id===id); return u?u.name:id; });
  alert('既読者:\n' + (names.length? names.join('\n') : 'なし'));
}

// admin user table render (show password editable)
function renderAdminTable(){
  adminUserTable.innerHTML = '';
  users.forEach((u, idx)=>{
    const tr = document.createElement('tr');
    const nameTd = document.createElement('td'); nameTd.textContent = u.name;
    const roleTd = document.createElement('td'); roleTd.textContent = roleLabel(u.role);
    const passTd = document.createElement('td');
    const passInput = document.createElement('input');
    passInput.type='text'; passInput.value = u.password; passInput.style.width='100%';
    passInput.onchange = ()=> { users[idx].password = passInput.value; localStorage.setItem(LS_USERS, JSON.stringify(users)); refreshUsers(); };
    passTd.appendChild(passInput);
    const opTd = document.createElement('td');
    const delBtn = document.createElement('button'); delBtn.textContent='削除'; delBtn.className='link-btn';
    delBtn.onclick = ()=> { if(confirm('削除しますか？')){ users.splice(idx,1); localStorage.setItem(LS_USERS, JSON.stringify(users)); refreshUsers(); } };
    opTd.appendChild(delBtn);
    tr.appendChild(nameTd); tr.appendChild(roleTd); tr.appendChild(passTd); tr.appendChild(opTd);
    adminUserTable.appendChild(tr);
  });
}

// add user
addUserBtn.addEventListener('click', ()=>{
  const name = newName.value.trim(); const role = newRole.value; const pass = newPass.value.trim();
  if(!name || !pass){ alert('氏名とパスワードを入力してください'); return; }
  const id = 'u' + Date.now();
  users.push({id, name, role, password: pass});
  localStorage.setItem(LS_USERS, JSON.stringify(users));
  newName.value=''; newPass.value='';
  refreshUsers();
});

// calendar render
function renderCalendar(){
  calendar = JSON.parse(localStorage.getItem(LS_CAL) || '[]');
  calendarList.innerHTML = '';
  calendar.forEach(ev=>{
    const li = document.createElement('li');
    li.textContent = ev.title + ' 〜 ' + ev.until;
    calendarList.appendChild(li);
  });
}
renderCalendar();

// calendar add (admin)
calAdd.addEventListener('click', ()=>{
  const t = calTitle.value.trim(); const u = calUntil.value.trim();
  if(!t || !u) { alert('タイトルと期限を入力してください'); return; }
  const id = 'ev' + Date.now();
  calendar.push({id, title: t, until: u});
  localStorage.setItem(LS_CAL, JSON.stringify(calendar));
  calTitle.value=''; calUntil.value='';
  renderCalendar();
});

// helper: role label string to internal key mapping for select if necessary
// (we use 'general','kicho','kacho' values for target selection)
// initial refresh
refreshUsers();
renderMessages();

// clear messages (dev)
document.getElementById('clear-btn').addEventListener('click', ()=>{
  if(confirm('メッセージをすべてクリアしますか？（ローカルの保存も消えます）')){
    localStorage.setItem(LS_MSGS, JSON.stringify([]));
    messages = [];
    renderMessages();
  }
});

// convenience: allow Enter to send in textarea (Ctrl+Enter on desktop)
msgText.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});
</script>
</body>
</html>